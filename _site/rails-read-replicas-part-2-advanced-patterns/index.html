<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.avif">











<!-- Primary Meta Tags -->
<title>Scaling Rails with PostgreSQL Read Replicas: Part 2 - Advanced Patterns and Gotchas | Prateek Codes - Learn Building Scalable Backend Systems</title>
<meta name="title" content="Scaling Rails with PostgreSQL Read Replicas: Part 2 - Advanced Patterns and Gotchas">
<meta name="description" content="Deep dive into handling replication lag, implementing automatic connection switching, and solving real-world challenges with read replicas in Rails appl...">
<meta name="keywords" content="Rails read replica patterns, replication lag Rails, sticky sessions Rails, connection pool optimization, Rails database scaling patterns, PostgreSQL replication lag, Rails, PostgreSQL, Database, Scaling, Ruby on Rails, PostgreSQL, Ruby, Rails development, Rails consulting">
<meta name="author" content="Prateek Choudhary">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:url" content="https://prateekcodes.dev/rails-read-replicas-part-2-advanced-patterns/">
<meta property="og:title" content="Scaling Rails with PostgreSQL Read Replicas: Part 2 - Advanced Patterns and Gotchas">
<meta property="og:description" content="Deep dive into handling replication lag, implementing automatic connection switching, and solving real-world challenges with read replicas in Rails appl...">
<meta property="og:image" content="https://prateekcodes.dev/assets/images/logo.avif">
<meta property="og:site_name" content="Prateek Codes - Learn Building Scalable Backend Systems">

<meta property="article:author" content="Prateek Choudhary">
<meta property="article:published_time" content="2025-06-25T00:00:00+00:00">


<meta property="article:tag" content="rails-read-replicas">

<meta property="article:tag" content="replication-lag">

<meta property="article:tag" content="connection-switching">

<meta property="article:tag" content="sticky-sessions">

<meta property="article:tag" content="rails-7">

<meta property="article:tag" content="postgresql">

<meta property="article:tag" content="database-patterns">



<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://prateekcodes.dev/rails-read-replicas-part-2-advanced-patterns/">
<meta property="twitter:title" content="Scaling Rails with PostgreSQL Read Replicas: Part 2 - Advanced Patterns and Gotchas">
<meta property="twitter:description" content="Deep dive into handling replication lag, implementing automatic connection switching, and solving real-world challenges with read replicas in Rails appl...">
<meta property="twitter:image" content="https://prateekcodes.dev/assets/images/logo.avif">
<meta property="twitter:creator" content="@prateekkish">

<!-- Canonical URL -->
<link rel="canonical" href="https://prateekcodes.dev/rails-read-replicas-part-2-advanced-patterns/">

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="Prateek Codes - Learn Building Scalable Backend Systems RSS Feed" href="https://prateekcodes.dev/feed.xml">






<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Scaling Rails with PostgreSQL Read Replicas: Part 2 - Advanced Patterns and Gotchas",
  "description": "Deep dive into handling replication lag, implementing automatic connection switching, and solving real-world challenges with read replicas in Rails appl...",
  
  "image": "https://prateekcodes.dev/assets/images/logo.avif",
  
  "datePublished": "2025-06-25T00:00:00+00:00",
  
  "dateModified": "2025-06-25T00:00:00+00:00",
  
  "author": {
    "@type": "Person",
    "name": "Prateek Choudhary",
    "url": "https://prateekcodes.dev",
    "sameAs": [
      "https://twitter.com/prateekkish",
      "https://www.linkedin.com/in/choudharyprateek/",
      "https://github.com/prateekkish"
    ]
  },
  "publisher": {
    "@type": "Organization",
    "name": "Prateek Codes - Learn Building Scalable Backend Systems",
    "logo": {
      "@type": "ImageObject",
      "url": "https://prateekcodes.dev/assets/images/logo.avif"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://prateekcodes.dev/rails-read-replicas-part-2-advanced-patterns/"
  },
  "keywords": "rails-read-replicas, replication-lag, connection-switching, sticky-sessions, rails-7, postgresql, database-patterns, Rails, PostgreSQL, Database, Scaling",
  "articleSection": "Rails",
  "wordCount": "2014"
}
</script>





<!-- Breadcrumb Navigation -->

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://prateekcodes.dev"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Rails",
      "item": "https://prateekcodes.dev/category/rails"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Scaling Rails with PostgreS...",
      "item": "https://prateekcodes.dev/rails-read-replicas-part-2-advanced-patterns/"
    }
  ]
}
</script>


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">



<script src="/assets/js/jquery.min.js"></script>

</head>


<!-- change your GA id in _config.yml -->
<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-158773406-2', 'auto');
    ga('send', 'pageview');
  </script>



<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img class="navbar-logo" src="/assets/images/logo.avif" alt="Prateek Codes - Learn Building Scalable Backend Systems" width="50px" height="">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item ">
                    <a class="nav-link" href="/">Blog</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/categories">Categories</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/projects">Projects</a>
                </li>
                

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Search a post..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-1 pl-0">
            
        </div>

        <!-- Post -->
        

        <div class="col-md-10 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Post Title -->
                <h1 class="posttitle">Scaling Rails with PostgreSQL Read Replicas: Part 2 - Advanced Patterns and Gotchas</h1>

            </div>            

            <!-- Post Featured Image -->
            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <p>In <a href="/rails-read-replicas-part-1-understanding-the-basics">Part 1</a>, we covered the basics of setting up read replicas. Now let’s tackle the challenging aspects that make the difference between a system that works in development and one that thrives in production.</p>

<h2 id="whats-covered">What’s Covered</h2>

<ul>
  <li><a href="#the-replication-lag-challenge">The Replication Lag Challenge</a></li>
  <li><a href="#implementing-sticky-sessions">Implementing Sticky Sessions</a></li>
  <li><a href="#advanced-query-routing-patterns">Advanced Query Routing Patterns</a></li>
  <li><a href="#connection-pool-management">Connection Pool Management</a></li>
  <li><a href="#handling-edge-cases">Handling Edge Cases</a></li>
  <li><a href="#testing-with-replicas">Testing with Replicas</a></li>
</ul>

<h2 id="the-replication-lag-challenge">The Replication Lag Challenge</h2>

<p>The biggest challenge with read replicas is replication lag—the delay between when data is written to the primary and when it appears on replicas. Let’s understand why this matters.</p>

<h3 id="the-invisible-update-problem">The “Invisible Update” Problem</h3>

<p>Here’s a scenario that can be frustrating:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ProfilesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">bio: </span><span class="n">params</span><span class="p">[</span><span class="ss">:bio</span><span class="p">])</span>
    
    <span class="n">redirect_to</span> <span class="n">profile_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">show</span>
    <span class="c1"># If this runs on a replica, user might see old data!</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The user updates their bio and gets redirected, but they see their old bio because the <code class="language-plaintext highlighter-rouge">show</code> action read from a replica that hadn’t received the update yet.</p>

<h2 id="implementing-sticky-sessions">Implementing Sticky Sessions</h2>

<p>Rails provides automatic connection switching to solve this problem through the <a href="https://api.rubyonrails.org/classes/ActiveRecord/Middleware/DatabaseSelector.html" target="_blank" rel="nofollow noopener noreferrer">DatabaseSelector middleware</a>.</p>

<h3 id="basic-configuration">Basic Configuration</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1"># config/environments/production.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> 
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> 
    <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span><span class="o">::</span><span class="no">Session</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This configuration creates “sticky sessions”—after a write operation, that user’s session reads from the primary database for 2 seconds, ensuring they see their own changes.</p>

<p>You can generate this configuration automatically using:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rails generate active_record:multi_db
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(See <a href="https://guides.rubyonrails.org/active_record_multiple_databases.html#activating-automatic-role-switching" target="_blank" rel="nofollow noopener noreferrer">Rails Guide on Activating Automatic Role Switching</a>)</p>

<h3 id="how-sticky-sessions-work">How Sticky Sessions Work</h3>

<p>Let’s trace through what happens:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="c1"># 1. User makes a POST request to update their profile</span>
<span class="c1"># POST /profile</span>
<span class="k">def</span> <span class="nf">update</span>
  <span class="n">current_user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">bio: </span><span class="s2">"New bio"</span><span class="p">)</span>  <span class="c1"># Write to primary</span>
  <span class="c1"># Rails automatically stores timestamp: session[:last_write_timestamp] = Time.current</span>
  <span class="n">redirect_to</span> <span class="n">profile_path</span>
<span class="k">end</span>

<span class="c1"># 2. Browser follows redirect</span>
<span class="c1"># GET /profile</span>
<span class="k">def</span> <span class="nf">show</span>
  <span class="c1"># Rails middleware checks: Time.current - session[:last_write_timestamp] &lt; 2.seconds</span>
  <span class="c1"># Since it's within 2 seconds, this query goes to PRIMARY, not replica</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="n">current_user</span>
<span class="k">end</span>

<span class="c1"># 3. User refreshes page 3 seconds later</span>
<span class="c1"># GET /profile</span>
<span class="k">def</span> <span class="nf">show</span>
  <span class="c1"># Now: Time.current - session[:last_write_timestamp] &gt; 2.seconds</span>
  <span class="c1"># This query can safely go to REPLICA</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="n">current_user</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="customizing-sticky-session-behavior">Customizing Sticky Session Behavior</h3>

<p>The default 2-second delay works for many apps, but sometimes you need more control. For example:</p>
<ul>
  <li>Financial transactions need longer consistency windows</li>
  <li>Critical paths like checkout flows should always use primary</li>
  <li>Different operations have different consistency requirements</li>
</ul>

<p>Here’s a custom resolver that addresses these needs:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="c1"># app/middleware/custom_database_resolver.rb</span>
<span class="k">class</span> <span class="nc">CustomDatabaseResolver</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
  <span class="no">CRITICAL_PATHS</span> <span class="o">=</span> <span class="sx">%w[/checkout /payment /account]</span><span class="p">.</span><span class="nf">freeze</span>
  
  <span class="k">def</span> <span class="nf">read_from_primary?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># Always use primary for critical paths</span>
    <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="no">CRITICAL_PATHS</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span> <span class="n">request</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="p">}</span>
    
    <span class="c1"># Check if we recently wrote data</span>
    <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">recently_wrote?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    
    <span class="c1"># Use primary for non-GET requests</span>
    <span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="nf">get?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="nf">head?</span>
  <span class="k">end</span>
  
  <span class="kp">private</span>
  
  <span class="k">def</span> <span class="nf">recently_wrote?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">last_write</span> <span class="o">=</span> <span class="n">last_write_timestamp</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">last_write</span>
    
    <span class="c1"># Different delays for different operations</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">session</span><span class="p">[</span><span class="ss">:critical_write</span><span class="p">]</span>
      <span class="mi">10</span><span class="p">.</span><span class="nf">seconds</span>  <span class="c1"># Financial operations need longer consistency</span>
    <span class="k">else</span>
      <span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span>   <span class="c1"># Normal operations</span>
    <span class="k">end</span>
    
    <span class="no">Time</span><span class="p">.</span><span class="nf">current</span> <span class="o">-</span> <span class="n">last_write</span> <span class="o">&lt;</span> <span class="n">delay</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">last_write_timestamp</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">session</span><span class="p">[</span><span class="ss">:last_write_timestamp</span><span class="p">]</span>
    <span class="k">return</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">timestamp</span>
    
    <span class="no">Time</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="n">timestamp</span><span class="p">.</span><span class="nf">to_i</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Use the custom resolver</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">CustomDatabaseResolver</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="advanced-query-routing-patterns">Advanced Query Routing Patterns</h2>

<p>Beyond sticky sessions, you need patterns for routing specific queries intelligently.</p>

<h3 id="pattern-1-smart-query-router">Pattern 1: Smart Query Router</h3>

<p>Build a router that intelligently decides where queries should go:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="c1"># app/services/smart_query_router.rb</span>
<span class="k">class</span> <span class="nc">SmartQueryRouter</span>
  <span class="c1"># Queries safe for replicas even with lag</span>
  <span class="no">REPLICA_SAFE_PATTERNS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">analytics: </span><span class="sr">/GROUP BY|COUNT\(\*\)|SUM\(|AVG\(/i</span><span class="p">,</span>
    <span class="ss">historical: </span><span class="sr">/created_at &lt; '</span><span class="si">#{</span><span class="mi">1</span><span class="p">.</span><span class="nf">hour</span><span class="p">.</span><span class="nf">ago</span><span class="si">}</span><span class="sr">'/</span><span class="p">,</span>
    <span class="ss">reference_data: </span><span class="sr">/countries|currencies|categories/</span>
  <span class="p">}.</span><span class="nf">freeze</span>
  
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">route</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="n">capture_sql</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">should_use_replica?</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
      <span class="n">model_class</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">yield</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="kp">private</span>
  
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">should_use_replica?</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
    <span class="c1"># Never use replica for write operations</span>
    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">sql</span> <span class="o">=~</span> <span class="sr">/INSERT|UPDATE|DELETE/i</span>
    
    <span class="c1"># Check if query matches safe patterns</span>
    <span class="no">REPLICA_SAFE_PATTERNS</span><span class="p">.</span><span class="nf">any?</span> <span class="k">do</span> <span class="o">|</span><span class="n">_type</span><span class="p">,</span> <span class="n">pattern</span><span class="o">|</span>
      <span class="n">sql</span> <span class="o">=~</span> <span class="n">pattern</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">capture_sql</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subscriber</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="s1">'sql.active_record'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
      <span class="n">event</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">Event</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">queries</span> <span class="o">&lt;&lt;</span> <span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">[</span><span class="ss">:sql</span><span class="p">]</span>
    <span class="k">end</span>
    
    <span class="k">yield</span>
    <span class="n">queries</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span>
  <span class="k">ensure</span>
    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">unsubscribe</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage</span>
<span class="no">SmartQueryRouter</span><span class="p">.</span><span class="nf">route</span><span class="p">(</span><span class="no">Order</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Order</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'created_at &lt; ?'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="nf">month</span><span class="p">.</span><span class="nf">ago</span><span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="ss">:total</span><span class="p">)</span>
<span class="k">end</span>
<span class="c1"># Automatically routed to replica because it's historical data</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="pattern-2-gradual-replica-adoption">Pattern 2: Gradual Replica Adoption</h3>

<p>Rolling out replicas gradually reduces risk:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="c1"># app/services/replica_rollout.rb</span>
<span class="k">class</span> <span class="nc">ReplicaRollout</span>
  <span class="no">ROLLOUT_PERCENTAGES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">analytics_queries: </span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># 100% of analytics use replicas</span>
    <span class="ss">search_queries: </span><span class="mi">50</span><span class="p">,</span>      <span class="c1"># 50% of searches use replicas</span>
    <span class="ss">user_profiles: </span><span class="mi">10</span><span class="p">,</span>       <span class="c1"># 10% of profile reads use replicas</span>
    <span class="ss">default: </span><span class="mi">0</span>               <span class="c1"># Everything else uses primary</span>
  <span class="p">}.</span><span class="nf">freeze</span>
  
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">with_smart_routing</span><span class="p">(</span><span class="n">query_type</span> <span class="o">=</span> <span class="ss">:default</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">percentage</span> <span class="o">=</span> <span class="no">ROLLOUT_PERCENTAGES</span><span class="p">[</span><span class="n">query_type</span><span class="p">]</span> <span class="o">||</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">should_use_replica?</span><span class="p">(</span><span class="n">percentage</span><span class="p">)</span>
      <span class="k">begin</span>
        <span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
        <span class="c1"># Fallback to primary on any replica issues</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">error</span> <span class="s2">"Replica failed: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="si">}</span><span class="s2">, falling back to primary"</span>
        <span class="k">yield</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">yield</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="kp">private</span>
  
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">should_use_replica?</span><span class="p">(</span><span class="n">percentage</span><span class="p">)</span>
    <span class="c1"># Use request ID for consistent routing per request</span>
    <span class="n">request_id</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">current</span><span class="p">[</span><span class="ss">:request_id</span><span class="p">]</span> <span class="o">||</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span>
    <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="n">request_id</span><span class="p">).</span><span class="nf">to_i</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">&lt;</span> <span class="n">percentage</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage in controllers</span>
<span class="k">class</span> <span class="nc">SearchController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="no">ReplicaRollout</span><span class="p">.</span><span class="nf">with_smart_routing</span><span class="p">(</span><span class="ss">:search_queries</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@results</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:q</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="pattern-3-read-your-writes-for-specific-models">Pattern 3: Read-Your-Writes for Specific Models</h3>

<p>The need for immediate consistency could be at the model level. Here’s a way to achieve that:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="c1"># app/models/concerns/immediate_consistency.rb</span>
<span class="k">module</span> <span class="nn">ImmediateConsistency</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
  
  <span class="n">included</span> <span class="k">do</span>
    <span class="c1"># Override connection to always use primary for this model</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">connection</span>
      <span class="k">return</span> <span class="k">super</span> <span class="k">unless</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">current_role</span> <span class="o">==</span> <span class="ss">:reading</span>
      
      <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :writing</span><span class="p">)</span> <span class="k">do</span>
        <span class="k">return</span> <span class="k">super</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Models that need immediate consistency</span>
<span class="k">class</span> <span class="nc">PaymentTransaction</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">ImmediateConsistency</span>
  <span class="c1"># All queries for this model use primary, even in a reading block</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">UserSession</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">ImmediateConsistency</span>
  <span class="c1"># Session data must always be current</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>⚠️ Warning</strong>: I do not recommend this pattern unless you know what you’re doing. It can be very easy to go wrong because:</p>
<ul>
  <li>The behavior is “magical” and not obvious to other developers</li>
  <li>Users of this model may see unintended behavior</li>
  <li>It overrides core Rails methods in non-obvious ways</li>
  <li>Debugging becomes difficult when queries don’t go where expected</li>
</ul>

<p>Consider explicit methods or service objects instead for better clarity.</p>

<h2 id="connection-pool-management">Connection Pool Management</h2>

<p>Read replicas require careful connection pool management to avoid exhaustion:</p>

<h3 id="understanding-the-problem">Understanding the Problem</h3>

<p>When you add read replicas, your connection usage multiplies. Each database configuration maintains its own connection pool, and these pools exist per process.</p>

<p>Consider a typical setup:</p>
<ul>
  <li>1 primary database</li>
  <li>2 read replicas</li>
  <li>5 connections per pool (Rails default)</li>
  <li>10 Puma workers</li>
</ul>

<p>This creates 150 total database connections (3 databases × 5 connections × 10 workers). Many databases have connection limits—PostgreSQL defaults to 100 connections. You’ll hit the limit before your application even starts serving traffic.</p>

<p>For a deeper understanding of connection pools, see the <a href="https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/ConnectionPool.html" target="_blank" rel="nofollow noopener noreferrer">Rails Connection Pool documentation</a> and this excellent article on <a href="https://www.postgresql.org/docs/current/runtime-config-connection.html" target="_blank" rel="nofollow noopener noreferrer">PostgreSQL connection pooling</a>.</p>

<h3 id="optimizing-connection-pools">Optimizing Connection Pools</h3>

<p>The key is to right-size your pools based on actual usage patterns. Primary databases handle all writes and need more connections, while replicas only handle reads and can work with fewer connections. Additionally, replicas can return idle connections more aggressively since read queries are typically shorter.</p>

<p>Here’s how to configure pools efficiently:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="c1"># config/database.yml</span>
<span class="ss">production:
  primary:
    pool: </span><span class="o">&lt;</span><span class="sx">%= ENV.fetch("PRIMARY_DB_POOL", 5) %&gt;
    # Keep more connections for primary (handles all writes)
    
  primary_replica:
    pool: &lt;%=</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"REPLICA_DB_POOL"</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%&gt;</span>
    <span class="c1"># Fewer connections per replica, but we have multiple replicas</span>
    <span class="ss">idle_timeout: </span><span class="mi">300</span>  <span class="c1"># Return idle connections faster</span>
    <span class="ss">checkout_timeout: </span><span class="mi">2</span>  <span class="c1"># Fail fast if no connections available</span>
    
  <span class="ss">primary_replica_2:
    pool: </span><span class="o">&lt;</span><span class="sx">%= ENV.fetch("REPLICA_DB_POOL", 3) %&gt;
    idle_timeout: 300
    checkout_timeout: 2

# app/models/application_record.rb
class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class =</span> <span class="kp">true</span>
  
  <span class="c1"># Distribute reads across multiple replicas</span>
  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> 
    <span class="ss">writing: :primary</span><span class="p">,</span>
    <span class="ss">reading: </span><span class="p">[</span><span class="ss">:primary_replica</span><span class="p">,</span> <span class="ss">:primary_replica_2</span><span class="p">].</span><span class="nf">sample</span>
  <span class="p">}</span>
  
  <span class="c1"># Better: Use a load balancer</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">reading_connection</span>
      <span class="n">replicas</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:primary_replica</span><span class="p">,</span> <span class="ss">:primary_replica_2</span><span class="p">]</span>
      <span class="n">replica</span> <span class="o">=</span> <span class="no">LoadBalancer</span><span class="p">.</span><span class="nf">least_connections</span><span class="p">(</span><span class="n">replicas</span><span class="p">)</span>
      
      <span class="n">configurations</span><span class="p">.</span><span class="nf">configs_for</span><span class="p">(</span><span class="ss">env_name: </span><span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">,</span> <span class="ss">name: </span><span class="n">replica</span><span class="p">.</span><span class="nf">to_s</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="per-feature-connection-pools">Per-Feature Connection Pools</h3>

<p>Different features need different pool sizes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1"># config/database.yml</span>
<span class="ss">production:
  </span><span class="c1"># Analytics jobs need more connections</span>
  <span class="ss">analytics_replica:
    </span><span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">replica_config</span>
    <span class="ss">pool: </span><span class="mi">10</span>
    
  <span class="c1"># API endpoints need fewer but faster connections  </span>
  <span class="ss">api_replica:
    </span><span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">replica_config</span>
    <span class="ss">pool: </span><span class="mi">3</span>
    <span class="ss">checkout_timeout: </span><span class="mi">1</span>
    
<span class="c1"># app/jobs/analytics_job.rb</span>
<span class="k">class</span> <span class="nc">AnalyticsJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">around_perform</span> <span class="k">do</span> <span class="o">|</span><span class="n">job</span><span class="p">,</span> <span class="n">block</span><span class="o">|</span>
    <span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :analytics_replica</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="handling-edge-cases">Handling Edge Cases</h2>

<h3 id="1-cross-database-joins">1. Cross-Database Joins</h3>

<p>Read replicas complicate joins across different models:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="c1"># This breaks with replicas</span>
<span class="k">def</span> <span class="nf">user_with_recent_orders</span>
  <span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>  <span class="c1"># From replica</span>
  <span class="k">end</span>
  
  <span class="c1"># This might use primary, causing a cross-database join attempt</span>
  <span class="n">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'created_at &gt; ?'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># Solution: Load everything in the same connection block</span>
<span class="k">def</span> <span class="nf">user_with_recent_orders</span>
  <span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:orders</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
        <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">orders: </span><span class="p">{</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="o">..</span> <span class="p">})</span>
        <span class="p">.</span><span class="nf">first</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="2-transactions-across-connections">2. Transactions Across Connections</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="c1"># This won't work as expected</span>
<span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Alice"</span><span class="p">)</span>  <span class="c1"># Primary</span>
  
  <span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># This runs outside the transaction!</span>
    <span class="no">Analytics</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Solution: Keep transactions on single connection</span>
<span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Alice"</span><span class="p">)</span>
  
  <span class="c1"># Explicitly use primary for analytics within transaction</span>
  <span class="no">Analytics</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :writing</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Analytics</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="testing-with-replicas">Testing with Replicas</h2>

<p>Testing replica behavior requires special setup:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="c1"># spec/support/replica_test_helper.rb</span>
<span class="k">module</span> <span class="nn">ReplicaTestHelper</span>
  <span class="k">def</span> <span class="nf">with_replica_lag</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
    <span class="c1"># Simulate lag by delaying replica queries</span>
    <span class="n">allow</span><span class="p">(</span><span class="no">ApplicationRecord</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:connected_to</span><span class="p">).</span><span class="nf">and_wrap_original</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:role</span><span class="p">]</span> <span class="o">==</span> <span class="ss">:reading</span>
        <span class="nb">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="nb">method</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="k">yield</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">assert_uses_replica</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="no">ApplicationRecord</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:connected_to</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span>
    <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">assert_uses_primary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="no">ApplicationRecord</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:connected_to</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span>
    <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># spec/controllers/profiles_controller_spec.rb</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">ProfilesController</span> <span class="k">do</span>
  <span class="kp">include</span> <span class="no">ReplicaTestHelper</span>
  
  <span class="n">it</span> <span class="s2">"uses primary database after writes"</span> <span class="k">do</span>
    <span class="n">post</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">bio: </span><span class="s2">"New bio"</span> <span class="p">}</span>
    
    <span class="n">assert_uses_primary</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="n">it</span> <span class="s2">"handles replica lag gracefully"</span> <span class="k">do</span>
    <span class="n">with_replica_lag</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:analytics</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_successful</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="whats-next">What’s Next?</h2>

<p>Make sure to check out:</p>
<ul>
  <li><a href="/rails-read-replicas-part-3-production-excellence">Part 3 - Production Excellence</a></li>
</ul>

<p>Remember: complexity should match your needs. Start with Rails’ built-in connection switching and add custom routing as specific use cases demand it.</p>

            </div>

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2025-06-25">25 Jun 2025</time></span>
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Database">Database</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#PostgreSQL">PostgreSQL</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Rails">Rails</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Scaling">Scaling</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Author Box -->
            
            <div class="row post-bottom-meta">
                <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                    
                    <img class="author-thumb" src="/assets/images/prateek-avatar.avif" alt="Prateek Choudhary">
                    
                </div>
                <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                    <a target="_blank" class="link-dark" href="prateekcodes.dev">Prateek Choudhary</a>
                    <section class="author-socials mb-0">
                        <a target="_blank" href="https://twitter.com/prateekkish"><i class="fab fa-twitter-square"></i></a>
                        <a target="_blank" href="https://github.com/prateekkish" class="ml-1"><i class="fab fa-github-square"></i></a>
                        <a target="_blank" href="https://www.linkedin.com/in/choudharyprateek/" class="ml-1"><i class="fab fa-linkedin"></i></a>
                        <a target="_blank" href="mailto:prateekkish@gmail.com" class="ml-1"><i class="fas fa-envelope-square"></i></a>
                    </section>
                    <section class="author-description">Technology Leader</section>
                </div>
            </div>
            
            <!-- End Author Box -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/tags#connection-switching">#connection-switching</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#database-patterns">#database-patterns</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#postgresql">#postgresql</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#rails-7">#rails-7</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#rails-read-replicas">#rails-read-replicas</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#replication-lag">#replication-lag</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#sticky-sessions">#sticky-sessions</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Related Posts -->
            





<div class="related-posts">
  <h3>Related Articles</h3>
  <div class="row">
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">
                  <a href="/rails-read-replicas-part-3-production-excellence/">Scaling Rails with PostgreSQL Read Replicas: Part 3 - Production Excellence</a>
                </h5>
                <p class="card-text small">Master production deployment strategies, monitoring, performance optimization, and failure handli...</p>
                <p class="card-text">
                  <small class="text-muted">
                    <time datetime="2025-06-25T00:00:00+00:00">Jun 25, 2025</time>
                  </small>
                </p>
              </div>
            </div>
          </div>
          
          
        
      
    
      
    
      
        
        
        
        
        
        
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">
                  <a href="/rails-read-replicas-part-1-understanding-the-basics/">Scaling Rails with PostgreSQL Read Replicas: Part 1 - Understanding the Basics</a>
                </h5>
                <p class="card-text small">Learn when and why to use read replicas in Rails applications, understand the architecture, and i...</p>
                <p class="card-text">
                  <small class="text-muted">
                    <time datetime="2025-06-25T00:00:00+00:00">Jun 25, 2025</time>
                  </small>
                </p>
              </div>
            </div>
          </div>
          
          
        
      
    
      
        
        
        
        
        
        
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">
                  <a href="/postgresql-17-merge-with-returning-for-rails-developers/">PostgreSQL 17's MERGE with RETURNING: The Game-Changer Rails Developers Have Been Waiting For</a>
                </h5>
                <p class="card-text small">PostgreSQL 17 introduces RETURNING support to the MERGE statement, solving a long-standing limita...</p>
                <p class="card-text">
                  <small class="text-muted">
                    <time datetime="2025-06-25T00:00:00+00:00">Jun 25, 2025</time>
                  </small>
                </p>
              </div>
            </div>
          </div>
          
          
        
      
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
      
    
      
        
        
        
        
        
        
      
    
    
    
    
  </div>
</div>
            <!-- End Related Posts -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-10">
                <script src="https://giscus.app/client.js"
        data-repo="prateekkish/prateekcodes"
        data-repo-id=""
        data-category="General"
        data-category-id=""
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light_protanopia"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

</script>

</div>



</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-12 text-center">
                <div class="contact-section">
                    <h5 class="contact-title">Let's Work Together</h5>
                    <p class="contact-subtitle">Need help scaling your backend systems? I can help you build robust, high-performance solutions.</p>
                    <div class="contact-links">
                        <a href="mailto:prateekkish@gmail.com" class="contact-link email-link">
                            <i class="fas fa-envelope"></i> Get in touch
                        </a>
                        <span class="contact-divider">•</span>
                        <a href="https://twitter.com/prateekkish" class="contact-link" target="_blank">
                            <i class="fab fa-twitter"></i> Twitter
                        </a>
                        <span class="contact-divider">•</span>
                        <a href="https://www.linkedin.com/in/choudharyprateek/" class="contact-link" target="_blank">
                            <i class="fab fa-linkedin"></i> LinkedIn
                        </a>
                        <span class="contact-divider">•</span>
                        <a href="https://github.com/prateekkish" class="contact-link" target="_blank">
                            <i class="fab fa-github"></i> GitHub
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <hr class="footer-divider">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2025 Prateek Codes - Learn Building Scalable Backend Systems
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">
                Built with Jekyll
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script>

</body>
</html>
